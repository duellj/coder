<?php
// $Id: coder.module,v 1.17 2006-12-29 18:39:12 douggreen Exp $

/** @file
 * Developer Module that assists with code review and version upgrade that
 * supports a plug-in extensible hook system so contributed modules can
 * define additional review standards.
 *
 * Built-in support for:
 * - Drupal Coding Standards - http://drupal.org/node/318
 * - Handle text in a secure fashion - http://drupal.org/node/28984
 * - Converting 4.6.x modules to 4.7.x - http://drupal.org/node/22218
 * - Converting 4.7.x modules to 5.x - http://drupal.org/node/64279
 *
 * Credit also to dries:
 * - http://cvs.drupal.org/viewcvs/drupal/drupal/scripts/code-style.pl
 */ 

/**
 * Implementation of hook_init().
 */
function coder_init() {
  // hook init is called even on cached pages, but we don't want to
  // actually do anything in that case.
  if (!function_exists('drupal_get_path')) {
    return;
  }

  // Load all our module 'on behalfs'.
  global $_coder_coders;
  $path = drupal_get_path('module', 'coder') . '/includes';
  $files = system_listing('coder_.*\.inc$', $path, 'name', 0);
  foreach ($files as $file) {
    require_once('./' . $file->filename);
    $_coder_coders[] = $file->name;
  }
}

/**
 * Get all of the code review modules
 */
function _coder_reviews() {
  $reviews = array();

  // get the review definitions from the include directory
  global $_coder_coders;
  if ($_coder_coders) {
    foreach ($_coder_coders as $coder) {
      $function = $coder . '_reviews';
      if (function_exists($function)) {
        if ($review = call_user_func($function)) {
          $reviews = array_merge($reviews, $review);
        }
      }
    }
  }

  // get the contributed module review definitions
  if ($review = module_invoke_all('reviews')) {
    $reviews = array_merge($reviews, $review);
  }

  return $reviews;
}

/**
 * Implementation of hook_help()
 */
function coder_help($section) { 
  switch ($section) { 
    case 'admin/modules#description': 
      return t('Developer Module that assists with code review and version upgrade');
    default :
      return;
  } 
} 

/**
 * Implementation of hook_cron().
 *
 * TODO: move some of the work here...
 */
function coder_cron() {
}

/**
 * Implementation of hook_perm().
 */
function coder_perm() {
  return array('view code review');
}

/**
 * Implementation of hook_menu().
 */
function coder_menu($may_cache) {
  $items = array();

  if ($may_cache) {
    $items[] = array(
      'path' => 'admin/coder',
      'title' => t('code review'),
      'callback' => 'coder_page',
      'access' => user_access('view code review'),
    );
  }

  return $items;
}

/**
 * Implementation of hook_form_alter().
 */
function coder_form_alter($form_id, &$form) {
  if ($form_id == 'system_modules') {
    if (user_access('view code review')) {
      foreach ($form['name'] as $name => &$data) {
        $data['#value'] = l($data['#value'], "admin/coder/$name");
      }
    }
  }
}

function _coder_default_reviews() {
  return array('drupal', 'security');
}

/**
 * Implementation of hook_settings().
 */
function coder_settings() {
  // get this variable once - do we want only active modules?
  $active = variable_get('coder_active_modules', 1);

  // create the list of review options from the coder review plug-ins
  $reviews = _coder_reviews();
  foreach ($reviews as $name => $review) {
    $review_options[$name] = $review['#title'];
  }

  // what review standards should be applied
  $form['coder_reviews_group'] = array(
    '#type' => 'fieldset',
    '#title' => t('Reviews'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );
  $form['coder_reviews_group']['coder_reviews'] = array(
    '#type' => 'checkboxes',
    '#options' => $review_options,
    '#description' => t('apply the checked coding reviews'),
    '#default_value' => variable_get('coder_reviews', _coder_default_reviews()),
  );
  
  // get the modules
  $sql = "SELECT name, status FROM {system} WHERE type = 'module'";
  if ($active == 1) {
    $sql .= " AND status=1";
  }
  $sql .= " ORDER BY weight ASC, filename ASC";
  $result = db_query($sql);
  while ($module = db_fetch_object($result)) {
    $name = $module->name;
    if (!$active && $module->status) {
      $name .= ' (active)';
    }
    $module_options[$module->name] = l($name, "admin/coder/$name");
    if ($module->status) {
      $default_coder_modules[] = $module->name;
    }
  }

  // display active modules option
  $form['coder_modules_group'] = array(
    '#type' => 'fieldset',
    '#title' => t('Modules'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );
  $form['coder_modules_group']['coder_active_modules'] = array(
    '#type' => 'checkbox',
    '#default_value' => $active,
    '#title' => t('code review all active modules'),
  );

  // display the modules in a fieldset
  $form['coder_modules_group']['coder_modules_subgroup'] = array(
    '#type' => 'fieldset',
    '#title' => t('Select Specific Modules'),
    '#collapsible' => TRUE,
    '#collapsed' => $active,
  );
  $modules = $active ? $default_coder_modules : variable_get('coder_modules', $default_coder_modules);
  $form['coder_modules_group']['coder_modules_subgroup']['coder_modules'] = array(
    '#type' => 'checkboxes',
    '#options' => $module_options,
    '#description' => t('code review the selected modules only'),
    '#default_value' => $modules,
  );

  return $form;
}

/**
 * Implementation of code review page
 */
function coder_page() {
  if (!user_access('view code review')) {
    return drupal_access_denied();
  }

  // get this variable once - do we want only active modules?
  $active = variable_get('coder_active_modules', 1);

  // get this once - list of the reviews to perform
  $reviews = array();
  $avail_reviews = _coder_reviews();
  $selected_reviews = variable_get('coder_reviews', _coder_default_reviews());
  foreach ($selected_reviews as $name => $checked) {
    if ($checked) {
      $reviews[$name] = $avail_reviews[$name];
    }
  }

  // get the list of the modules
  $sql = "SELECT name, filename, status FROM {system} WHERE type = 'module'";
  if ($active == 1) {
    $sql .= " AND status=1";
  }
  $result = db_query($sql);
  while ($module = db_fetch_object($result)) {
    if ($module->status) {
      $default_coder_modules[$module->name] = $module->name;
    }
    $files[$module->name] = $module->filename;
  }

  // determine which modules are selected
  if ($module = arg(2)) {
    $modules = array($module => $module);
    $do_includes = 1;
  }
  else {
    $modules = $active ? $default_coder_modules : variable_get('coder_modules', $default_coder_modules);
  }
  if ($modules) {
    // loop through the selected modules, preparing the code review results
    $dups = array(); // used to avoid duplicate includes
    foreach ($modules as $name => $checked) {
      if ($checked) {
        // process this one file
        unset($includefiles);
        $filename = $files[$name];
        $results = do_coder_reviews($reviews, $name, $filename);
        $output .= theme('coder', $name, $filename, $results);

        // process the same directory include files
        if ($do_includes) {
          $path = dirname($filename);
          if (!isset($dups[$path])) {
            $dups[$path] = 1;
            $includefiles = system_listing('.*\.inc$', $path, 'name', 0);
            foreach ($includefiles as $file) {
              $results = do_coder_reviews($reviews, $name, $file->filename);
              $output .= theme('coder', $name, $file->filename, $results);
            }
          }
        }
      }
    }

    // prepend any output with the list of code reviews performed
    if ($output) {
      foreach ($reviews as $review) {
        $items[] = l($review['#title'], $review['#link']);
      }
      $output = '<div class="reviews">' . theme('reviews', $items, t('The code was checked using the following review guidelines')) . '</div>' . $output;
    }
  }
  return $output;
}

function do_coder_reviews($reviews, $name, $filename) {
  $results = array();

  // get the path to the module file
  if ($filename && $filepath = realpath($filename)) {
    // read the file
    $orig_lines = file($filepath);

    // strip single line comments
    $lines = preg_replace('/(\/\/[^:].*|\/\*.*\*\/)/', '', $orig_lines);

    // replace strings inside quotes with less complicated strings
    $lines = preg_replace('/"[^"]*"/', '""', $lines);
    $lines = preg_replace('/\'[^\']*\'/', '\'\'', $lines);

    // remove multi-comments (original code from code-style.pl)
    foreach ($lines as $lineno => $line) {
      // catch multi-line comments
      if (isset($comment)) {
        if (preg_match('/.*\*\//', $line)) {
          $line = preg_replace('/.*\*\//', '', $line);
          unset($comment);
        }
        else {
          $line = '';
        }
      }
      if (preg_match('/\/\*.*/', $line)) {
        $line = preg_replace('/\/\*.*/', '', $line);
        $comment = 1;
      }

      // save the new line, without the comments
      $lines[$lineno] = $line;
    }

    // now do all of the code reviews
    foreach ($reviews as $review) {
      if ($result = do_coder_review($review, $orig_lines, $lines)) {
        $results += $result;
      }
    }
  }

  // always display something
  if (count($results) == 0) {
    $results[0] = theme('coder_warning', 0, t('No Problems Found'));
  }
  else {
    ksort($results, SORT_NUMERIC);
  }

  return $results;
}

function do_coder_review($review, $orig_lines, $lines) {
  $results = array();
  if ($review['#rules']) {
    foreach ($review['#rules'] as $rule) {
      $review_lines = $rule['#original'] ? $orig_lines : $lines;
      switch ($rule['#type']) {
        case 'regex':
          do_coder_review_regex($rule, $review_lines, $results, $tmp);
          break;
        case 'grep':
          do_coder_review_grep($rule, $review_lines, $results, $tmp);
          break;
        case 'callback':
          do_coder_review_callback($rule, $orig_lines, $lines, $results, $tmp);
          break;
      }
    }
  }
  return $results;
}

function do_coder_review_regex($rule, $lines, &$results, &$tmp) {
  if ($regex = $rule['#value']) {
    $regex = '/' . $regex . '/i';
    foreach ($lines as $lineno => $line) {
      if (preg_match($regex, $line)) {
        global $_coder_errno;
        $key = $lineno + 1 + ($coder_errno ++ / 100000);
        $results[$key] = theme('coder_warning', $lineno + 1, $rule['#warning']);
      }
    }
  }
}

function do_coder_review_grep($rule, $lines, &$results, &$tmp) {
  if ($regex = $rule['#value']) {
    $regex = '/' . $regex . '/i';
    foreach ($lines as $lineno => $line) {
      if (preg_match($regex, $line)) {
        return;
      }
    }
    $results[0] = theme('coder_warning', 0, $rule['#warning']);
  }
}

function do_coder_review_callback($rule, $orig_lines, $lines, &$results, &$tmp) {
  if ($function = $rule['#value']) {
    if (function_exists($function)) {
      call_user_func($function, $orig_lines, $lines, &$results, &$tmp);
    }
  }
}

/**
 * Theming functions below...
 */

function theme_reviews($items, $message = '') {
  return $message . theme('item_list', $items, NULL, 'ol');
}

function theme_coder($name, $filename, $results) {
  $output  = '<div class="coder"><h2>' . $name . ': ' . $filename . '</h2>';
  if (count($results)) {
    $output .= theme('item_list', $results);
  }
  $output .= '</div>';
  return $output;
}

function theme_coder_warning($lineno, $warning) {
  if ($lineno) {
    return '<div class="coder_warning">' . t('Line') . ' ' . $lineno . ': ' . $warning . '</div>';
  }
  return '<div class="coder_warning">' . $warning . '</div>';
}
